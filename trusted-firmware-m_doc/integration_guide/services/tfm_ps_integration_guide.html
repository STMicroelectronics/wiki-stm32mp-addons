<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protected Storage Service Integration Guide &mdash; Trusted Firmware-M v2.1.0-stm32mp-r1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/tfm_custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Adding Secure Partition" href="tfm_secure_partition_addition.html" />
    <link rel="prev" title="Platform Service Integration Guide" href="tfm_platform_integration_guide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Trusted Firmware-M
              <img src="../../_static/tf_logo_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v2.1.0-stm32mp-r1

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../security/threat_models/generic_threat_model.html">Threat model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security_advisories/index.html">Security Advisories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../security/security_advisories/stack_seal_vulnerability.html">Advisory TFMV-1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security_advisories/svc_caller_sp_fetching_vulnerability.html">Advisory TFMV-2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security_advisories/crypto_multi_part_ops_abort_fail.html">Advisory TFMV-3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security_advisories/profile_small_key_id_encoding_vulnerability.html">Advisory TFMV-4</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security_advisories/fwu_write_vulnerability.html">Advisory TFMV-5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security_advisories/cc3xx_partial_tag_compare_on_chacha20_poly1305.html">Advisory TFMV-6</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security_advisories/debug_log_vulnerability.html">Advisory TFMV-7</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Releases</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../releases/2.1.0.html">v2.1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/2.0.0.html">v2.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/1.8.1.html">v1.8.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/1.8.0.html">v1.8.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../releases/release_process.html">Release Cadence and Process</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../platform/index.html">Platforms</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../platform/arm/index.html">Arm</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/arm/corstone1000/readme.html">Corstone-1000</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/arm/mps3/corstone300/README.html">Corstone-300 FPGA (AN547 and AN552) and FVP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/arm/mps3/corstone310/README.html">Corstone-310 FPGA (AN555) and FVP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/arm/mps4/corstone315/README.html">Corstone-315 FVP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/arm/musca_b1/readme.html">Musca-B1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/arm/musca_s1/readme.html">Musca-S1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/arm/rse/index.html">Runtime Security Engine</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../platform/armchina/index.html">ArmChina</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/armchina/mps3/alcor/README.html">Alcor FPGA (AN557)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../platform/cypress/index.html">Cypress</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/cypress/psoc64/index.html">PSoC64</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../platform/lairdconnectivity/index.html">Laird Connectivity</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/lairdconnectivity/bl5340_dvk_cpuapp/README.html">BL5340</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../platform/nordic_nrf/index.html">Nordic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/nordic_nrf/nrf5340dk_nrf5340_cpuapp/README.html">nRF5340</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/nordic_nrf/nrf9160dk_nrf9160/README.html">nRF9160</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/nordic_nrf/nrf9161dk_nrf9161/README.html">nRF9161</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../platform/nuvoton/index.html">Nuvoton</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/nuvoton/m2351/README.html">NuMaker-PFM-M2351</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/nuvoton/m2354/README.html">NuMaker-PFM-M2354</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../platform/nxp/index.html">NXP</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/nxp/lpcxpresso55s69/README.html">LPCXpresso55S69</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../platform/stm/index.html">STMICROELECTRONICS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/common/stm32h5xx/readme.html">STM32H5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/common/stm32l5xx/readme.html">STM32L5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/common/stm32mp2xx/readme.html">STM32MP2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/common/stm32u5xx/readme.html">STM32U5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/nucleo_l552ze_q/readme.html">NUCLEO_L552ZE_Q</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32h573i_dk/readme.html">STM32H573I_DK</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32l562e_dk/readme.html">STM32L562E_DK</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32mp215f_dk/readme.html">stm32mp215f_dk</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32mp257f_ev1/readme.html">stm32mp257f_ev1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/b_u585i_iot02a/readme.html">B_U585I_IOT02A</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../building/tfm_build_instruction.html">Build instructions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../building/tests_build_instruction.html">Build Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../building/run_tfm_examples_on_arm_platforms.html">Run TF-M tests and applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../building/documentation_generation.html">Building the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../building/tfm_build_instruction_iar.html">IAR toolchain</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../configuration/build_configuration.html">Build configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration/header_file_system.html">Component configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration/kconfig_system.html">Kconfig</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration/profiles/index.html">Profiles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/profiles/tfm_profile_small.html"> Small</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/profiles/tfm_profile_medium_arot-less.html"> ARoT-less</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/profiles/tfm_profile_medium.html"> Medium</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/profiles/tfm_profile_large.html"> Large</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration/test_configuration.html">Tests configuration</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Integration Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../source_structure/source_structure.html">Source Structure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../source_structure/platform_folder.html">Details for the /platform folder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../source_structure/platform_ext_folder.html">Details for the /platform/ext folder</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../spm_backends.html">SPM Backends</a></li>
<li class="toctree-l2"><a class="reference internal" href="../non-secure_client_extension_integration_guide.html">NS client integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../os_migration_guide_armv8m.html">OS migration to Armv8-M</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tfm_fpu_support.html">Floating-Point Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tfm_secure_irq_integration_guide.html">Secure Interrupt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platform_provisioning.html">Platform Provisioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platform/index.html">Adding a new platform</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../platform/porting_tfm_to_a_new_hardware.html">Porting TF-M to a New Hardware</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/documenting_platform.html">Platform Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/platform_deprecation.html">Platform deprecation and removal</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Services</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="tfm_attestation_integration_guide.html">Initial Attestation</a></li>
<li class="toctree-l3"><a class="reference internal" href="tfm_crypto_integration_guide.html">Crypto</a></li>
<li class="toctree-l3"><a class="reference internal" href="tfm_its_integration_guide.html">Internal Trusted Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="tfm_platform_integration_guide.html">Platform</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Protected Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="tfm_secure_partition_addition.html">Adding a New Secure Partition</a></li>
<li class="toctree-l3"><a class="reference internal" href="tfm_manifest_tool_user_guide.html">Manifest Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="tfm_adac_integration_guide.html">ADAC</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../design_docs/index.html">Design Documents</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../design_docs/booting/tfm_secure_boot.html">Secure Boot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/booting/bl1.html">BL1 Immutable bootloader</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/booting/secure_boot_rollback_protection.html">Rollback Protection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/booting/secure_boot_hw_key_integration.html">HW Key integration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design_docs/dual-cpu/index.html">Dual CPU</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/dual-cpu/booting_a_dual_core_system.html">Booting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/dual-cpu/communication_prototype_between_nspe_and_spe_in_dual_core_systems.html">SPE - NSPE communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/dual-cpu/mailbox_design_on_dual_core_system.html">Mailbox</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/dual-cpu/mailbox_ns_agent_update.html">Mailbox update</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/dual-cpu/tfm_multi_core_access_check.html">Memory Access Check</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design_docs/services/index.html">Secure Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/secure_partition_manager.html">Secure Partition Manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/secure_partition_runtime_library.html">Secure Partition RTL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/tfm_psa_inter_process_communication.html">Inter-Process Communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/stateless_rot_service.html">Stateless Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/tfm_uniform_secure_service_signature.html">Service Signing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/tfm_crypto_design.html">Crypto</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/symmetric_initial_attest.html">Initial Attestation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/tfm_its_service.html">Internal Trusted Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/tfm_fwu_service.html">Firmware Update</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/services/ps_key_management.html">PS Key Management</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design_docs/software/index.html">Software Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/software/code_sharing.html">Code Sharing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/software/hardware_abstraction_layer.html">Hardware Abstraction Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/software/tfm_cooperative_scheduling_rules.html">Cooperative Scheduling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/software/tfm_code_generation_with_jinja2.html">Code Templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../design_docs/software/enum_implicit_casting.html">Implicit Typecasting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../design_docs/ff_isolation.html">Isolation Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design_docs/tfm_builtin_keys.html">Builtin Keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design_docs/tfm_log_system_design_document.html">Logging system</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design_docs/tfm_physical_attack_mitigation.html">Physical Attack Mitigation</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contribution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Guidelines</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/contributing_process.html">The process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/code_review_guide.html">Code review</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/maintainers.html">Maintainers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/maintainers.html#code-owners">Code owners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/coding_guide.html">Yet another coding standard :)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/doc_guidelines.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/tfm_design_proposal_guideline.html">Design proposal</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/lic.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/dco.html">DCO</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://trustedfirmware-m.readthedocs.io/projects/tf-m-tests/en/latest/">TF-M Tests</a></li>
<li class="toctree-l1"><a class="reference external" href="https://trustedfirmware-m.readthedocs.io/projects/tf-m-tools/en/latest/">TF-M Tools</a></li>
<li class="toctree-l1"><a class="reference external" href="https://trustedfirmware-m.readthedocs.io/projects/tf-m-extras/en/latest/">TF-M Extras</a></li>
<li class="toctree-l1"><a class="reference external" href="https://ci.trustedfirmware.org/job/tf-m-build-docs-nightly/lastSuccessfulBuild/artifact/trusted-firmware-m/build/docs/reference_manual/html/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://developer.trustedfirmware.org/w/collaboration/security_center">Security Center</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.arm.com/architecture/security-features/platform-security">PSA</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">STMICROELECTRONICS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../stm/releases/index.html">Releases</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../stm/releases/getting_started.html">Getting started</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32h573i_dk/readme.html">STM32H573I_DK</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32l562e_dk/readme.html">STM32L562E_DK</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32mp215f_dk/readme.html">stm32mp215f_dk</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32mp257f_ev1/readme.html">stm32mp257f_ev1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/nucleo_l552ze_q/readme.html">NUCLEO_L552ZE_Q</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/b_u585i_iot02a/readme.html">B_U585I_IOT02A</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../stm/releases/platforms.html">Platforms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/common/stm32h5xx/readme.html">STM32H5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/common/stm32l5xx/readme.html">STM32L5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/common/stm32mp2xx/readme.html">STM32MP2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/common/stm32u5xx/readme.html">STM32U5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/nucleo_l552ze_q/readme.html">NUCLEO_L552ZE_Q</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32h573i_dk/readme.html">STM32H573I_DK</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32l562e_dk/readme.html">STM32L562E_DK</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32mp215f_dk/readme.html">stm32mp215f_dk</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../platform/stm/stm32mp257f_ev1/readme.html">stm32mp257f_ev1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../stm/releases/changelog.html">Change Log &amp; Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../stm/releases/v1.7.0/index.html">v1.7.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../stm/releases/v2.1.0/index.html">v2.1.0</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../stm/releases/index.html#branch-plans">Branch plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stm/technical/index.html">Technical references</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../stm/technical/a35_td_flavor/index.html">A35-TD flavor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../stm/technical/a35_td_flavor/memory_layout.html">Memory layout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../stm/technical/a35_td_flavor/storage.html">Storage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../stm/technical/m33_td_flavor/index.html">M33-TD flavor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../stm/technical/m33_td_flavor/memory_layout.html">Memory layout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../stm/technical/m33_td_flavor/storage.html">Storage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../stm/technical/devicetree/index.html">Devicetree</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../stm/technical/devicetree/devicetree_tfm.html">Scope and purpose</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../stm/technical/devicetree/devicetree_tfm.html#concept">Concept</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../stm/technical/devicetree/devicetree_tfm.html#how-to-add-device">How to add device</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../stm/technical/initlevel.html">Initlevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../stm/technical/initial_attestation.html">Initial Attestation Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../stm/technical/nv_counter.html">Nv counter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../stm/ide/index.html">Ide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../stm/ide/cube/stm32cubeide.html">STM32CubeIDE</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Trusted Firmware-M</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Integration Guide</a></li>
          <li class="breadcrumb-item"><a href="index.html">Services</a></li>
      <li class="breadcrumb-item active">Protected Storage Service Integration Guide</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="protected-storage-service-integration-guide">
<h1>Protected Storage Service Integration Guide<a class="headerlink" href="#protected-storage-service-integration-guide" title="Permalink to this heading"></a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>TF-M Protected Storage (PS) service implements PSA Protected Storage APIs.</p>
<p>The service is usually backed by hardware isolation of the flash
access domain and, in the current version, relies on hardware to
isolate the flash area from non-secure access. In absence of hardware
isolation, the secrecy and integrity of data is still maintained.</p>
<p>The PS service implements an AES-GCM based AEAD encryption policy, as a
reference, to protect data integrity and authenticity.</p>
<p>The PS reuses the non-hierarchical filesystem provided by the TF-M
Internal Trusted Storage service to store encrypted, authenticated
objects.</p>
<p>The design addresses the following high level requirements as well:</p>
<ul class="simple">
<li><p><strong>Confidentiality</strong> - Resistance to unauthorised accesses through
hardware/software attacks.</p></li>
<li><p><strong>Access Authentication</strong> - Mechanism to establish requester’s identity (a
non-secure entity, secure entity, or a remote server).</p></li>
<li><p><strong>Integrity</strong> - Resistant to tampering by either the normal users of a
product, package, or system or others with physical access to it. If the
content of the protected storage is changed maliciously, the service is able
to detect it.</p></li>
<li><p><strong>Reliability</strong> - Resistant to power failure scenarios and incomplete write
cycles.</p></li>
<li><p><strong>Configurability</strong> - High level configurability to scale up/down memory
footprint to cater for a variety of devices with varying security
requirements.</p></li>
<li><p><strong>Performance</strong> - Optimized to be used for resource constrained devices with
very small silicon footprint, the PPA (power, performance, area) should be
optimal.</p></li>
</ul>
</div>
<div class="section" id="current-ps-service-limitations">
<h2>Current PS Service Limitations<a class="headerlink" href="#current-ps-service-limitations" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Asset size limitation</strong> - An asset is stored in a contiguous space in a
block/sector. Hence, the maximum asset size can be up-to the size of the
data block/sector. Detailed information about the maximum asset size can be
found in the section <cite>Maximum asset size</cite> below.</p></li>
<li><p><strong>Fragmentation</strong> - The current design does not support fragmentation, as an
asset is stored in a contiguous space in a block.
Each block can potentially store multiple assets.
A delete operation implicitly moves all the assets towards the top of the
block to avoid fragmentation within block. However, this may also result in
unutilized space at the end of each block.</p></li>
<li><p><strong>Non-hierarchical storage model</strong> - The current design uses a
non-hierarchical storage model, as a filesystem, where all the assets are
managed by a linearly indexed list of metadata. This model locates the
metadata in blocks which are always stored in the same flash location. That
increases the number of writes in a specific flash location as every change in
the storage area requires a metadata update.</p></li>
<li><p><strong>PSA internal trusted storage API</strong> - In the current design, the service does
not use the PSA Internal Trusted Storage API to write the rollback protection
values stored in the internal storage.</p></li>
<li><p><strong>Protection against physical storage medium failure</strong> - Complete handling of
inherent failures of storage mediums (e.g. bad blocks in a NAND based device)
is not supported by the current design.</p></li>
<li><p><strong>Key diversification</strong> - In a more robust design, each asset would be
encrypted through a different key.</p></li>
<li><p><strong>Lifecycle management</strong> - Currently, it does not support any subscription
based keys and certificates required in a secure lifecycle management. Hence,
an asset’s validity time-stamp can not be invalidated based on the system
time.</p></li>
<li><p><strong>Provisioning vs user/device data</strong> - In the current design, all assets are
treated in the same manner. In an alternative design, it may be required to
create separate partitions for provisioning content and user/device generated
content. This is to allow safe update of provisioning data during firmware
updates without the need to wipe out the user/device generated data.</p></li>
</ul>
</div>
<div class="section" id="code-structure">
<h2>Code Structure<a class="headerlink" href="#code-structure" title="Permalink to this heading"></a></h2>
<p>Protected storage service code is located in
<code class="docutils literal notranslate"><span class="pre">secure_fw/partitions/protected_storage/</span></code> and is divided as follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>Core files</p></li>
<li><p>Cryptographic interfaces</p></li>
<li><p>Non-volatile (NV) counters interfaces</p></li>
</ul>
</div></blockquote>
<p>The PSA PS interfaces for PS service are located in <code class="docutils literal notranslate"><span class="pre">interface/include/psa</span></code></p>
<div class="section" id="psa-protected-storage-interfaces">
<h3>PSA Protected Storage Interfaces<a class="headerlink" href="#psa-protected-storage-interfaces" title="Permalink to this heading"></a></h3>
<p>The PS service exposes the following mandatory PSA PS interfaces, version 1.0:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">psa_status_t</span><span class="w"> </span><span class="nf">psa_ps_set</span><span class="p">(</span><span class="n">psa_storage_uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">data_length</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p_data</span><span class="p">,</span><span class="w"> </span><span class="n">psa_storage_create_flags_t</span><span class="w"> </span><span class="n">create_flags</span><span class="p">);</span>
<span class="n">psa_status_t</span><span class="w"> </span><span class="nf">psa_ps_get</span><span class="p">(</span><span class="n">psa_storage_uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">data_offset</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">data_size</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p_data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">p_data_length</span><span class="p">);</span>
<span class="n">psa_status_t</span><span class="w"> </span><span class="nf">psa_ps_get_info</span><span class="p">(</span><span class="n">psa_storage_uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">psa_storage_info_t</span><span class="w"> </span><span class="o">*</span><span class="n">p_info</span><span class="p">);</span>
<span class="n">psa_status_t</span><span class="w"> </span><span class="nf">psa_ps_remove</span><span class="p">(</span><span class="n">psa_storage_uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">);</span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">psa_ps_get_support</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></div>
</div>
<p>For the moment, it does not support the extended version of those APIs.</p>
<p>These PSA PS interfaces and PS TF-M types are defined and documented in
<code class="docutils literal notranslate"><span class="pre">interface/include/psa/protected_storage.h</span></code>,
<code class="docutils literal notranslate"><span class="pre">interface/include/psa/storage_common.h</span></code> and
<code class="docutils literal notranslate"><span class="pre">interface/include/tfm_ps_defs.h</span></code></p>
</div>
<div class="section" id="core-files">
<h3>Core Files<a class="headerlink" href="#core-files" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tfm_ps_req_mngr.c</span></code> - Contains the PS request manager implementation which
handles all requests which arrive to the service. This layer extracts the
arguments from the input and output vectors, and it calls the protected
storage layer with the provided parameters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tfm_protected_storage.c</span></code> - Contains the TF-M protected storage API
implementations which are the entry points to the PS service.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ps_object_system.c</span></code> - Contains the object system implementation to manage
all objects in PS area.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ps_object_table.c</span></code> - Contains the object system table implementation which
complements the object system to manage all object in the PS area.
The object table has an entry for each object stored in the object system
and keeps track of its version and owner.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ps_encrypted_object.c</span></code> - Contains an implementation to manipulate
encrypted objects in the PS object system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ps_utils.c</span></code> - Contains common and basic functionalities used across the
PS service code.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ps_filesystem_interface.c</span></code> - Contains the interface to directly use ITS
implementation of services.</p></li>
</ul>
</div>
<div class="section" id="flash-filesystem-and-flash-interfaces">
<h3>Flash Filesystem and Flash Interfaces<a class="headerlink" href="#flash-filesystem-and-flash-interfaces" title="Permalink to this heading"></a></h3>
<p>The non-hierarchical filesystem and flash interfaces reside under
Internal Trusted Storage service directory. The way PS service uses
them depends on the config option <code class="docutils literal notranslate"><span class="pre">TFM_PARTITION_INTERNAL_TRUSTED_STORAGE</span></code>.</p>
<p>When TF-M Internal trusted storage service is active (i.e.
<code class="docutils literal notranslate"><span class="pre">TFM_PARTITION_INTERNAL_TRUSTED_STORAGE</span></code> = ON), all file system and storage
interfaces are built as part of ITS service library. Thus, the PS service stores
encrypted, authenticated objects by making service calls to the ITS service.</p>
<p>When TF-M Internal trusted storage service is disabled (i.e.
<code class="docutils literal notranslate"><span class="pre">TFM_PARTITION_INTERNAL_TRUSTED_STORAGE</span></code> = OFF), all file system and storage
interfaces are built as part of PS service library. Thus, the PS service stores
encrypted, authenticated objects by making standard function calls to the file
system within its own partition code.</p>
<p>The ITS filesystem and flash interfaces and their implementation can be found in
<code class="docutils literal notranslate"><span class="pre">secure_fw/partitions/internal_trusted_storage/flash_fs</span></code> and
<code class="docutils literal notranslate"><span class="pre">secure_fw/partitions/internal_trusted_storage/flash</span></code> respectively. More
information about the filesystem and flash interfaces can be found in the
<a class="reference internal" href="tfm_its_integration_guide.html"><span class="doc">ITS integration guide</span></a>.</p>
<p>The ITS service implementation in
<code class="docutils literal notranslate"><span class="pre">secure_fw/partitions/internal_trusted_storage/tfm_internal_trusted_storage.c</span></code>,
constructs a filesystem configuration for Protected Storage based on
target-specific definitions from the Protected Storage HAL. Please see the
<cite>Protected Storage Service HAL</cite> section for details of these.</p>
</div>
<div class="section" id="cryptographic-interface">
<h3>Cryptographic Interface<a class="headerlink" href="#cryptographic-interface" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">crypto/ps_crypto_interface.h</span></code> - Abstracts the cryptographic operations for
the protected storage service.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">crypto/ps_crypto_interface.c</span></code> - Implements the PS service cryptographic
operations with calls to the TF-M Crypto service.</p></li>
</ul>
</div>
<div class="section" id="non-volatile-nv-counters-interface">
<h3>Non-volatile (NV) Counters Interface<a class="headerlink" href="#non-volatile-nv-counters-interface" title="Permalink to this heading"></a></h3>
<p>The current PS service provides rollback protection based on NV
counters.
PS defines and implements the following NV counters functionalities:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nv_counters/ps_nv_counters.h</span></code> - Abstracts PS non-volatile
counters operations. This API detaches the use of NV counters from the TF-M NV
counters implementation, provided by the platform, and provides a mechanism to
compile in a different API implementation for test purposes. A PS test suite
<strong>may</strong> provide its own custom implementation to be able to test different PS
service use cases.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nv_counters/ps_nv_counters.c</span></code> - Implements the PS NV counters interfaces
based on TF-M NV counters implementation provided by the platform.</p></li>
</ul>
</div>
</div>
<div class="section" id="ps-service-integration-guide">
<h2>PS Service Integration Guide<a class="headerlink" href="#ps-service-integration-guide" title="Permalink to this heading"></a></h2>
<p>This section describes mandatory (i.e. <strong>must</strong> implement) or optional
(i.e. <strong>may</strong> implement) interfaces which the system integrator have to take
in to account in order to integrate the protected storage service in a new
platform.</p>
<div class="section" id="maximum-asset-size">
<h3>Maximum Asset Size<a class="headerlink" href="#maximum-asset-size" title="Permalink to this heading"></a></h3>
<p>An asset is stored in a contiguous space in a block/sector. The maximum
size of an asset can be up-to the size of the data block/sector minus the object
header size (<code class="docutils literal notranslate"><span class="pre">PS_OBJECT_HEADER_SIZE</span></code>) which is defined in
<code class="docutils literal notranslate"><span class="pre">ps_object_defs.h</span></code>. The <code class="docutils literal notranslate"><span class="pre">PS_OBJECT_HEADER_SIZE</span></code> changes based on the
<code class="docutils literal notranslate"><span class="pre">PS_ENCRYPTION</span></code> flag status.</p>
</div>
<div class="section" id="protected-storage-service-hal">
<h3>Protected Storage Service HAL<a class="headerlink" href="#protected-storage-service-hal" title="Permalink to this heading"></a></h3>
<p>The PS service requires the platform to implement the PS HAL, defined in
<code class="docutils literal notranslate"><span class="pre">platform/include/tfm_hal_ps.h</span></code>.</p>
<p>The following C definitions in the HAL are mandatory, and must be defined by the
platform in a header named <code class="docutils literal notranslate"><span class="pre">flash_layout.h</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TFM_HAL_PS_FLASH_DRIVER</span></code> - Defines the identifier of the CMSIS Flash
ARM_DRIVER_FLASH object to use for PS. It must have been allocated by the
platform and will be declared extern in the HAL header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TFM_HAL_PS_PROGRAM_UNIT</span></code> - Defines the size of the PS flash device’s
physical program unit (the smallest unit of data that can be individually
programmed to flash). It must be equal to
<code class="docutils literal notranslate"><span class="pre">TFM_HAL_PS_FLASH_DRIVER.GetInfo()-&gt;program_unit</span></code>, but made available at
compile time so that filesystem structures can be statically sized. Valid
values are powers of two between 1 and the flash sector size, inclusive.</p></li>
</ul>
<p>The following C definitions in the HAL may optionally be defined by the platform
in the <code class="docutils literal notranslate"><span class="pre">flash_layout.h</span></code> header:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TFM_HAL_PS_FLASH_AREA_ADDR</span></code> - Defines the base address of the dedicated
flash area for PS.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TFM_HAL_PS_FLASH_AREA_SIZE</span></code> - Defines the size of the dedicated flash area
for PS in bytes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TFM_HAL_PS_SECTORS_PER_BLOCK</span></code> - Defines the number of contiguous physical
flash erase sectors that form a logical erase block in the filesystem. The
typical value is <code class="docutils literal notranslate"><span class="pre">1</span></code>, but it may be increased so that the maximum required
asset size will fit in one logical block.</p></li>
</ul>
<p>If any of the above definitions are not provided by the platform, then the
<code class="docutils literal notranslate"><span class="pre">tfm_hal_ps_fs_info()</span></code> HAL API must be implemented instead. This function is
documented in <code class="docutils literal notranslate"><span class="pre">tfm_hal_ps.h</span></code>.</p>
<p>The sectors reserved to be used for Protected Storage <strong>must</strong> be contiguous
sectors starting at <code class="docutils literal notranslate"><span class="pre">TFM_HAL_PS_FLASH_AREA_ADDR</span></code>.</p>
<p>The design requires either 2 blocks, or any number of blocks greater than or
equal to 4. Total number of blocks can not be 0, 1 or 3. This is a design choice
limitation to provide power failure safe update operations.</p>
</div>
<div class="section" id="protected-storage-service-optional-platform-definitions">
<h3>Protected Storage Service Optional Platform Definitions<a class="headerlink" href="#protected-storage-service-optional-platform-definitions" title="Permalink to this heading"></a></h3>
<p>The following optional platform definitions may be defined in
<code class="docutils literal notranslate"><span class="pre">flash_layout.h</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PS_RAM_FS_SIZE</span></code> - Defines the size of the RAM FS buffer when using the
RAM FS emulated flash implementation. The buffer must be at least as large as
the area earmarked for the filesystem by the HAL.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_FLASH_NAND_BUF_SIZE</span></code> - Defines the size of the write buffer when using
the NAND flash implementation. The buffer must be at least as large as a
logical filesystem block.</p></li>
</ul>
<p>More information about the <code class="docutils literal notranslate"><span class="pre">flash_layout.h</span></code> content, not ITS related, is
available in <a class="reference internal" href="../source_structure/platform_ext_folder.html#platform-ext-folder"><span class="std std-ref">Details for the platform/ext folder</span></a> along with other
platform information.</p>
</div>
<div class="section" id="tf-m-nv-counter-interface">
<h3>TF-M NV Counter Interface<a class="headerlink" href="#tf-m-nv-counter-interface" title="Permalink to this heading"></a></h3>
<p>To have a platform independent way to access the NV counters, TF-M defines a
platform NV counter interface. For API specification, please check:
<code class="docutils literal notranslate"><span class="pre">platform/include/tfm_plat_nv_counters.h</span></code></p>
<p>The system integrators <strong>may</strong> implement this interface based on the target
capabilities and set the <code class="docutils literal notranslate"><span class="pre">PS_ROLLBACK_PROTECTION</span></code> flag to compile in
the rollback protection code.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>If this flag is enabled, the lifecycle of the PS service depends on the
shorter write endurance of the assets storage device and the NV counters
storage device.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="secret-platform-unique-key">
<h3>Secret Platform Unique Key<a class="headerlink" href="#secret-platform-unique-key" title="Permalink to this heading"></a></h3>
<p>The encryption policy relies on a secret hardware unique key (HUK) per device.
It is system integrator’s responsibility to provide an implementation which
<strong>must</strong> be a non-mutable target implementation.
For API specification, please check:
<code class="docutils literal notranslate"><span class="pre">platform/include/tfm_plat_crypto_keys.h</span></code></p>
<p>A stub implementation is provided in
<code class="docutils literal notranslate"><span class="pre">platform/ext/common/template/crypto_keys.c</span></code></p>
</div>
<div class="section" id="non-secure-identity-manager">
<h3>Non-Secure Identity Manager<a class="headerlink" href="#non-secure-identity-manager" title="Permalink to this heading"></a></h3>
<p>TF-M core tracks the current client IDs running in the secure or non-secure
processing environment. It provides a dedicated API to retrieve the client ID
which performs the service request.</p>
<p><a class="reference internal" href="../non-secure_client_extension_integration_guide.html"><span class="doc">Non-secure Client Extension Integration Guide</span></a>
provides further details on how client identification works.</p>
<p>PS service uses that TF-M core API to retrieve the client ID and associate it
as the owner of an asset. Only the owner can read, write or delete that asset
based on the creation flags.</p>
<p>The <a class="reference internal" href="../index.html"><span class="doc">integration guide</span></a>
provides further details of non-secure implementation requirements for TF-M.</p>
</div>
<div class="section" id="id1">
<h3>Cryptographic Interface<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>The reference encryption policy is built on AES-GCM, and it <strong>may</strong> be replaced
by a vendor specific implementation.</p>
<p>The PS service abstracts all the cryptographic requirements and specifies the
required cryptographic interface in
<code class="docutils literal notranslate"><span class="pre">secure_fw/partitions/protected_storage/crypto/ps_crypto_interface.h</span></code></p>
<p>The PS service cryptographic operations are implemented in
<code class="docutils literal notranslate"><span class="pre">secure_fw/partitions/protected_storage/crypto/ps_crypto_interface.c</span></code>, using
calls to the TF-M Crypto service.</p>
</div>
<div class="section" id="ps-service-build-definitions">
<h3>PS Service Build Definitions<a class="headerlink" href="#ps-service-build-definitions" title="Permalink to this heading"></a></h3>
<p>The PS service uses a set of C definitions to compile in/out certain features,
as well as to configure certain service parameters. When using the TF-M build
system, these definitions are controlled by build flags of the same name. The
<code class="docutils literal notranslate"><span class="pre">config/config_base.cmake</span></code> file sets the default values of those flags, but
they can be overwritten based on platform capabilities by setting them in
<code class="docutils literal notranslate"><span class="pre">platform/ext/target/&lt;TARGET_NAME&gt;/config.cmake</span></code>. The list of PS service build
definitions is:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_ENCRYPTION</span></code>- this flag allows to enable/disable encryption
option to encrypt the protected storage data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_CRYPTO_AEAD_ALG</span></code> - this flag indicates the AEAD algorithm to use for
authenticated encryption in Protected Storage.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For GCM/CCM it is essential that IV doesn’t get repeated. If this flag is
set to <code class="docutils literal notranslate"><span class="pre">PSA_ALG_GCM</span></code> or <code class="docutils literal notranslate"><span class="pre">PSA_ALG_CCM</span></code>, <code class="docutils literal notranslate"><span class="pre">PS_ROLLBACK_PROTECTION</span></code> must
be enabled to protect against IV rollback.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_CREATE_FLASH_LAYOUT</span></code>- this flag indicates that it is required
to create a PS flash layout. If this flag is set, PS service will
generate an empty and valid PS flash layout to store assets. It will
erase all data located in the assigned PS memory area before generating
the PS layout.  This flag is required to be set if the PS memory area
is located in a non-persistent memory.  This flag can be set if the PS
memory area is located in a persistent memory without a valid PS flash
layout in it. That is the case when it is the first time in the device
life that the PS service is executed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_VALIDATE_METADATA_FROM_FLASH</span></code>- this flag allows to
enable/disable the validation mechanism to check the metadata store in flash
every time the flash data is read from flash. This validation is required
if the flash is not hardware protected against malicious writes. In case
the flash is protected against malicious writes (i.e embedded flash, etc),
this validation can be disabled in order to reduce the validation overhead.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_ROLLBACK_PROTECTION</span></code>- this flag allows to enable/disable
rollback protection in protected storage service. This flag takes effect only
if the target has non-volatile counters and <code class="docutils literal notranslate"><span class="pre">PS_ENCRYPTION</span></code> flag is on.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_RAM_FS</span></code>- setting this flag to <code class="docutils literal notranslate"><span class="pre">ON</span></code> enables the use of RAM instead of
the persistent storage device to store the FS in the Protected Storage
service. This flag is <code class="docutils literal notranslate"><span class="pre">OFF</span></code> by default. The PS regression tests write/erase
storage multiple time, so enabling this flag can increase the life of flash
memory when testing.
If this flag is set to <code class="docutils literal notranslate"><span class="pre">ON</span></code>, PS_RAM_FS_SIZE must also be provided. This
specifies the size of the block of RAM to be used to simulate the flash.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If this flag is disabled when running the regression tests, then it is
recommended that the persistent storage area is erased before running the
tests to ensure that all tests can run to completion. The type of persistent
storage area is platform specific (eFlash, MRAM, etc.) and it is described
in corresponding flash_layout.h</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_MAX_ASSET_SIZE</span></code> - Defines the maximum asset size to be stored in the
PS area. This size is used to define the temporary buffers used by PS to
read/write the asset content from/to flash. The memory used by the temporary
buffers is allocated statically as PS does not use dynamic memory allocation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_NUM_ASSETS</span></code> - Defines the maximum number of assets to be stored in the
PS area. This number is used to dimension statically the object table size in
RAM (fast access) and flash (persistent storage). The memory used by the
object table is allocated statically as PS does not use dynamic memory
allocation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_TEST_NV_COUNTERS</span></code>- this flag enables the virtual implementation of the
PS NV counters interface in <code class="docutils literal notranslate"><span class="pre">test/secure_fw/suites/ps/secure/nv_counters</span></code> of
the <code class="docutils literal notranslate"><span class="pre">tf-m-tests</span></code> repo, which emulates NV counters in
RAM, and disables the hardware implementation of NV counters provided by
the secure service. This flag is enabled by default, but has no effect when
the secure regression test is disabled. This flag can be
overridden to <code class="docutils literal notranslate"><span class="pre">OFF</span></code> when building the regression tests. In this case,
the PS rollback protection test suite will not be built, as it relies
on extra functionality provided by the virtual NV counters to simulate
different rollback scenarios. The remainder of the PS test suites will
run using the hardware NV counters. Please note that running the tests in
this configuration will quickly increase the hardware NV counter values,
which cannot be decreased again.
Overriding this flag from its default value of <code class="docutils literal notranslate"><span class="pre">OFF</span></code> when not
building the regression tests is not currently supported.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PS_STACK_SIZE</span></code>- Defines the stack size of the Protected Storage Secure
Partition. This value mainly depends on the build type(debug, release and
minisizerel) and compiler.</p></li>
</ul>
<hr class="docutils" />
<p><em>Copyright (c) 2018-2024, Arm Limited. All rights reserved.</em>
<em>Copyright (c) 2020, Cypress Semiconductor Corporation. All rights reserved.</em></p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>